<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GSOD Interpolation as an Improved Alternative To NASA POWER Agroclimatology Data â€¢ GRID</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">GRID</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Getting_started_with_Docker.html">Getting started with Docker</a>
    </li>
    <li>
      <a href="../articles/GSOD_Interpolation_as_an_Enhanced_Alternative_To_NASA_POWER_Agroclimatology_Data.html">GSOD Interpolation as an Improved Alternative To NASA POWER Agroclimatology Data</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ropensci/GRID">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>GSOD Interpolation as an Improved Alternative To NASA POWER Agroclimatology Data</h1>
                        <h4 class="author">Adam H. Sparks - Centre for Crop Health, USQ</h4>
            
            <h4 class="date">2017-07-09</h4>
          </div>

    
    
<div class="contents">
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>Global Surface Summary of the Day - GSOD data, <a href="https://data.noaa.gov/dataset/global-surface-summary-of-the-day-gsod">(link)</a> is free, ground-based (or bouy) weather station data with global coverage. When properly cleaned and interpolated this data can provide a better alternative to NASA/POWER for agroclimatology work. This document describes how to reproduce these data using freely available data, software and methodologies.</p>
</div>
<div id="install-and-load-the-necessary-r-packages" class="section level1">
<h1 class="hasAnchor">
<a href="#install-and-load-the-necessary-r-packages" class="anchor"></a>Install and Load the Necessary R Packages</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(GSODR)
<span class="kw">library</span>(doParallel)
<span class="kw">library</span>(foreach)
<span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(raster)
<span class="kw">library</span>(rastervis)
<span class="kw">library</span>(readr)
<span class="kw">library</span>(rgdal)</code></pre></div>
</div>
<div id="fetch-and-import-weather-data" class="section level1">
<h1 class="hasAnchor">
<a href="#fetch-and-import-weather-data" class="anchor"></a>Fetch and Import Weather Data</h1>
<p>Using the <code><a href="http://www.rdocumentation.org/packages/GSODR/topics/get_GSOD">get_GSOD()</a></code> function from <em>GSODR</em>, download and reformat Global Surface Summary of the Day (GSOD) weather data from the US National Climatic Data Center (NCDC) for the year 2010 between latitudes -60 and 60 only. This process will take several minutes or hours depending on Internet connection and processor speed to download and clean the data. The resulting comma separated values (CSV) file is roughly 465mb.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">GSOD &lt;-<span class="st"> </span>GSODR<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/GSODR/topics/get_GSOD">get_GSOD</a></span>(<span class="dt">years =</span> <span class="dv">2010</span><span class="op">:</span><span class="dv">2011</span>, <span class="dt">max_missing =</span> <span class="dv">5</span>, <span class="dt">agroclimatology =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p>Inspect the data frame of the GSOD data and plot the station locations included in the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(GSOD)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># plot station locations</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="dt">data =</span> GSOD, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">y =</span> LAT, <span class="dt">x =</span> LON)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">xlab</a></span>(<span class="st">"LON"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ylab</a></span>(<span class="st">"LAT"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/coord_map">coord_map</a></span>()</code></pre></div>
</div>
<div id="fetch-import-and-process-elevation-data" class="section level1">
<h1 class="hasAnchor">
<a href="#fetch-import-and-process-elevation-data" class="anchor"></a>Fetch, Import and Process Elevation Data</h1>
<p>Download Shuttle Radar Topography Mission (SRTM) digital elevation model (DEM) data from the Worldclim Database <a href="http://www.worldclim.org/">(link)</a> to use in the interpolation as an elevation covariate. Set data type to INT2S since the .bil file is unsigned, set -9999 to NA, then aggregate to 1 arc-degree to match NASA/POWER. Since the DEM covers more area than the agroclimatology data from the <code>GSODR</code> package, crop the DEM to match the extent before plotting.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># set up workspace</span>
tf.zip &lt;-<span class="st"> </span><span class="kw">tempfile</span>()

<span class="kw">download.file</span>(
  <span class="st">"http://biogeo.ucdavis.edu/data/climate/worldclim/1_4/grid/cur/alt_10m_bil.zip"</span>,
  <span class="dt">destfile =</span> tf.zip, <span class="dt">mode =</span> <span class="st">"wb"</span>)
<span class="kw">unzip</span>(tf.zip, <span class="dt">exdir =</span> <span class="kw">tempdir</span>()) <span class="co"># unzip downloaded file</span>
z &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/raster">raster</a></span>(<span class="kw">paste0</span>(<span class="kw">tempdir</span>(), <span class="st">"/alt.bil"</span>)) <span class="co"># import elevation raster object</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/dataType">dataType</a></span>(z) &lt;-<span class="st"> "INT2S"</span>

<span class="co"># aggregate the SRTM data</span>
z &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/aggregate">aggregate</a></span>(z, <span class="dv">6</span>) <span class="co"># aggregate up to 1deg to match NASA/POWER resolution</span>
z[z <span class="op">==</span><span class="st"> </span><span class="op">-</span><span class="dv">9999</span>] &lt;-<span class="st"> </span><span class="ot">NA</span> <span class="co"># set -9999 to NA</span>

z <span class="co"># inspect the object</span>

<span class="co"># crop SRTM data at -60/60 for agroclimatology only</span>
agro &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/extent">extent</a></span>(<span class="kw">c</span>(<span class="dt">xmin =</span> <span class="op">-</span><span class="dv">180</span>, <span class="dt">xmax =</span> <span class="dv">180</span>, <span class="dt">ymin =</span> <span class="op">-</span><span class="dv">60</span>, <span class="dt">ymax =</span> <span class="dv">60</span>))
z &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/crop">crop</a></span>(z, agro)

z_spdf &lt;-<span class="st"> </span><span class="kw">as</span>(z, <span class="st">"SpatialPixelsDataFrame"</span>)
z_df &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/as.data.frame">as.data.frame</a></span>(z_spdf)
<span class="kw">colnames</span>(z_df) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"value"</span>, <span class="st">"x"</span>, <span class="st">"y"</span>)

<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_tile">geom_tile</a></span>(<span class="dt">data =</span> z_df, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">fill =</span> value)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_viridis</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">xlab</a></span>(<span class="st">"LON"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ylab</a></span>(<span class="st">"LAT"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/coord_map">coord_map</a></span>()</code></pre></div>
</div>
<div id="daily-weather-data-cleaning-thin-plate-splining-and-interpolation" class="section level1">
<h1 class="hasAnchor">
<a href="#daily-weather-data-cleaning-thin-plate-splining-and-interpolation" class="anchor"></a>Daily Weather Data Cleaning, Thin Plate Splining and Interpolation</h1>
<p>GSOD temperature data are checked for consistency using <code>boxplot.stats()</code> to identify and remove daily outliers for both TMAX and TMIN, separately.</p>
<p>Once the GSOD data are cleaned, thin plate splining, the <code>Tps()</code> function, from <em>fields</em> is used to create an object that can then be used to create an interpolated surface of temperatures using the SRTM DEM with the <code><a href="http://www.rdocumentation.org/packages/raster/topics/interpolate">interpolate()</a></code> function from <em>raster</em>.</p>
<p>Use <em>foreach</em> to iterate through the data paralellising the process.</p>
<ol style="list-style-type: decimal">
<li><p>check for outliers in GSOD data and remove them,</p></li>
<li><p>interpolate creating a global surface from the values,</p></li>
<li><p>write GeoTIFF files to disk for every day, every weather variable specified.</p></li>
</ol>
<p>This is an extremly processor and time-intensive process for the entire global dataset. It is suggested to use a computer dedicated just to this task, while it will run on a fairly modest desktop, the computer may become unresponsive while performing this operation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(<span class="kw">detectCores</span>() <span class="op">-</span><span class="st"> </span><span class="dv">2</span>)
<span class="kw"><a href="http://www.rdocumentation.org/packages/doParallel/topics/registerDoParallel">registerDoParallel</a></span>(cl)
YEARMODA &lt;-<span class="st"> </span><span class="dv">20100101</span> <span class="co"># set this to c(2010:2011) to run all days, two years.</span>
itx &lt;-<span class="st"> </span><span class="kw">iter</span>(YEARMODA)
ity &lt;-<span class="st"> </span><span class="kw">iter</span>(<span class="kw">c</span>(<span class="st">"TEMP"</span>, <span class="st">"MIN"</span>, <span class="st">"MAX"</span>))
i &lt;-<span class="st"> </span><span class="ot">NULL</span>
j &lt;-<span class="st"> </span><span class="ot">NULL</span>

<span class="kw"><a href="http://www.rdocumentation.org/packages/foreach/topics/foreach">foreach</a></span>(<span class="dt">i =</span> itx, <span class="dt">.packages =</span> <span class="kw">c</span>(<span class="st">"fields"</span>, <span class="st">"raster"</span>, <span class="st">"foreach"</span>)) <span class="op">%dopar%</span><span class="st"> </span>{
  <span class="kw"><a href="http://www.rdocumentation.org/packages/foreach/topics/foreach">foreach</a></span>(<span class="dt">t =</span> ity) <span class="op">%do%</span><span class="st"> </span>{
    j &lt;-<span class="st"> </span>GSOD[GSOD<span class="op">$</span>YEARMODA <span class="op">==</span><span class="st"> </span>i, ][, <span class="kw">c</span>(<span class="dv">8</span><span class="op">:</span><span class="dv">9</span>, <span class="dv">11</span>, <span class="dv">19</span>, <span class="dv">33</span>, <span class="dv">35</span>)]
    j &lt;-<span class="st"> </span>j[<span class="kw">complete.cases</span>(j), ]
    
    <span class="co"># create object with x, y and weather var</span>
    gsod_temp &lt;-<span class="st"> </span><span class="kw">na.omit</span>(<span class="kw">data.frame</span>(j<span class="op">$</span>LON, j<span class="op">$</span>LAT, j<span class="op">$</span>ELEV_M_SRTM_90m,
                                    <span class="kw">as.numeric</span>(<span class="kw">paste0</span>(j[[t]]))))
    
    <span class="co"># remove outliers</span>
    temp_bxs &lt;-<span class="st"> </span><span class="kw">boxplot.stats</span>(gsod_temp[, <span class="dv">4</span>])
    temp &lt;-<span class="st"> </span>gsod_temp[<span class="op">!</span>gsod_temp[, <span class="dv">4</span>] <span class="op">%in%</span><span class="st"> </span>temp_bxs<span class="op">$</span>out, ]
    
    <span class="co"># create correction dataset</span>
    temp_vals &lt;-<span class="st"> </span>temp[, <span class="dv">4</span>]
    <span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/names">names</a></span>(temp_vals) &lt;-<span class="st"> </span><span class="ot">NULL</span>
    temp_xyz &lt;-<span class="st"> </span>temp[, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]
    
    <span class="co"># create thin plate spline object</span>
    tps_temp &lt;-<span class="st"> </span>fields<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/fields/topics/Tps">Tps</a></span>(temp_xyz[, <span class="kw">c</span>(<span class="st">"j.LON"</span>, <span class="st">"j.LAT"</span>, <span class="st">"j.ELEV_M_SRTM_90m"</span>)],
                            temp_vals, <span class="dt">lon.lat =</span> <span class="ot">TRUE</span>)
    
    <span class="co"># interpolate thin plate spline object and write to disk</span>
    tps_pred_temp &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/interpolate">interpolate</a></span>(z, tps_temp, <span class="dt">xyOnly =</span> <span class="ot">FALSE</span>)
    
    <span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/writeRaster">writeRaster</a></span>(tps_pred_temp,
                <span class="dt">filename =</span> <span class="kw">paste0</span>(<span class="st">"~/GTiff/GSOD_SRTM.90m_"</span>, t, <span class="st">"_"</span>, i, <span class="st">".tiff"</span>),
                <span class="dt">format =</span> <span class="st">"GTiff"</span>, <span class="dt">dataType =</span> <span class="st">"INT2S"</span>,
                <span class="dt">options =</span> <span class="kw">c</span>(<span class="st">"COMPRESS=LZW"</span>, <span class="st">"TFW=YES"</span>),
                <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)
  }
}

<span class="kw">stopCluster</span>(cl)</code></pre></div>
<hr>
</div>
<div id="appendices" class="section level1">
<h1 class="hasAnchor">
<a href="#appendices" class="anchor"></a>Appendices</h1>
<div id="computer-information" class="section level2">
<h2 class="hasAnchor">
<a href="#computer-information" class="anchor"></a>Computer Information</h2>
<blockquote>
<p><strong>iMac (21.5-inch, Late 2015)</strong><br><strong>Processor</strong> 2.8 GHz Intel Core i5<br><strong>Memory</strong> 8 GB 1867 MHz DDR3</p>
</blockquote>
</div>
<div id="r-session-information" class="section level2">
<h2 class="hasAnchor">
<a href="#r-session-information" class="anchor"></a>R Session Information</h2>
<pre><code>## R version 3.4.1 (2017-06-30)
## Platform: x86_64-apple-darwin16.6.0 (64-bit)
## Running under: macOS Sierra 10.12.5
## 
## Matrix products: default
## BLAS/LAPACK: /usr/local/Cellar/openblas/0.2.19_1/lib/libopenblasp-r0.2.19.dylib
## 
## locale:
## [1] en_AU.UTF-8/en_AU.UTF-8/en_AU.UTF-8/C/en_AU.UTF-8/en_AU.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] checkpoint_0.4.1
## 
## loaded via a namespace (and not attached):
##  [1] compiler_3.4.1  backports_1.1.0 magrittr_1.5    rprojroot_1.2  
##  [5] tools_3.4.1     htmltools_0.3.6 yaml_2.1.14     Rcpp_0.12.11   
##  [9] stringi_1.1.5   rmarkdown_1.6   knitr_1.16      stringr_1.2.0  
## [13] digest_0.6.12   evaluate_0.10.1</code></pre>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#install-and-load-the-necessary-r-packages">Install and Load the Necessary R Packages</a></li>
      <li><a href="#fetch-and-import-weather-data">Fetch and Import Weather Data</a></li>
      <li><a href="#fetch-import-and-process-elevation-data">Fetch, Import and Process Elevation Data</a></li>
      <li><a href="#daily-weather-data-cleaning-thin-plate-splining-and-interpolation">Daily Weather Data Cleaning, Thin Plate Splining and Interpolation</a></li>
      <li>
<a href="#appendices">Appendices</a><ul class="nav nav-pills nav-stacked">
<li><a href="#computer-information">Computer Information</a></li>
      <li><a href="#r-session-information">R Session Information</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Adam Sparks, Andrew Nelson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
